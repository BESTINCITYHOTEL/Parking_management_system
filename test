<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ì£¼ì°¨ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }

    .top-buttons {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .top-buttons button {
      font-size: 22px;
      background: none;
      border: none;
      cursor: pointer;
    }

    .parking-container {
      position: relative;
      width: 100%;
      max-width: 900px;
      height: 600px;
      margin: auto;
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      grid-template-rows: repeat(18, 1fr);
      gap: 5px;
      background: url('ë„ë©´ì´ë¯¸ì§€.png') no-repeat center center;
      background-size: cover;
    }

    .spot {
      width: 100%;
      height: 100%;
      aspect-ratio: 2 / 1;
      background-color: green;
      color: white;
      text-align: center;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 12px;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      line-height: 1.2;
      padding: 5px;
      text-shadow: 1px 1px 3px black;
      box-sizing: border-box;
      white-space: nowrap;
      position: relative;
    }

    .occupied {
      background-color: red;
    }

    .empty {
      background: none;
      pointer-events: none;
      border: 1px solid transparent;
    }

    .edit-mode .empty {
      background-color: #444;
      pointer-events: auto;
    }

    .edit-mode .empty::before {
      content: '+';
      color: white;
      font-size: 20px;
    }

    .edit-mode .spot.active:not(.occupied)::after {
      content: '-';
      position: absolute;
      top: 3px;
      right: 6px;
      font-size: 16px;
      color: white;
    }

    .border-top {
      border-top: 3px solid black;
    }

    .border-bottom {
      border-bottom: 3px solid black;
    }

    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 30px;
      border-radius: 10px;
      z-index: 1000;
      width: 90%;
      max-width: 450px;
      box-sizing: border-box;
    }

    .modal input {
      width: 100%;
      padding: 15px;
      margin: 5px 0;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      box-sizing: border-box;
    }

    .modal-buttons {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 10px;
    }

    .modal-buttons button {
      flex: 1;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      color: white;
      box-sizing: border-box;
    }

    .modal-buttons .remove {
      background-color: orange;
    }

    .modal-buttons .cancel {
      background-color: red;
    }

    .modal-buttons #submitBtn {
      background-color: green;
    }

    .preview-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 20px;
      border-radius: 10px;
      z-index: 1000;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .preview-table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }

    .preview-table th, .preview-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }

    .preview-table th {
      background-color: #444;
    }

    .preview-table tr:nth-child(even) {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .preview-summary {
      margin: 10px 0;
      padding: 10px;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
    }

    .error-list {
      background-color: rgba(255, 0, 0, 0.1);
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      max-height: 200px;
      overflow-y: auto;
    }

    .error-list details summary {
      cursor: pointer;
      font-weight: bold;
      margin-bottom: 4px;
    }
    .error-list details[open] summary {
      color: #e63737;
    }
    .error-list details {
      margin-bottom: 4px;
    }

    @media (max-width: 600px) {
      .parking-container {
        height: 400px;
      }

      .spot {
        font-size: 10px;
        padding: 3px;
      }

      .modal {
        width: 95%;
        padding: 20px;
      }

      .modal input {
        padding: 12px;
        font-size: 14px;
      }

      .modal-buttons button {
        padding: 10px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <h2>ì£¼ì°¨ ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>
  <div class="top-buttons">
    <button id="clearAllBtn">ğŸ§¹</button>
    <button id="editModeBtn">ğŸš—</button>
    <button id="pasteIcon">ğŸ“‹</button>
    <button id="resetToDefaultBtn" style="display:none">ğŸ”„</button>
  </div>
  <p id="status">í˜„ì¬ ì£¼ì°¨ëœ ì°¨ëŸ‰: 0ëŒ€ / ë‚¨ì€ ìë¦¬: 39ëŒ€</p>

  <div class="parking-container" id="parkingLot"></div>

  <div id="modal" class="modal">
    <h3>ì£¼ì°¨ ì •ë³´ ìˆ˜ì •</h3>
    <input type="text" id="room" placeholder="ì…ì‹¤ í˜¸ìˆ˜" inputmode="numeric" />
    <input type="text" id="car" placeholder="ì°¨ëŸ‰ ë’·ë²ˆí˜¸" inputmode="numeric" />
    <div class="modal-buttons">
      <button class="remove" id="removeBtn">ì¶œì°¨</button>
      <button id="submitBtn">ì €ì¥</button>
      <button class="cancel" id="cancelBtn">ì·¨ì†Œ</button>
    </div>
  </div>

  <div id="previewModal" class="preview-modal">
    <h3>ë°ì´í„° ì—…ë°ì´íŠ¸ ë¯¸ë¦¬ë³´ê¸°</h3>
    <div class="preview-summary">
      <p>ì´ <span id="totalCount">0</span>ê°œì˜ ë°ì´í„° ì¤‘ <span id="matchCount">0</span>ê°œ ë§¤ì¹­ë¨</p>
    </div>
    <div id="previewContent">
      <table class="preview-table">
        <thead>
          <tr>
            <th>ì£¼ì°¨ ìœ„ì¹˜</th>
            <th>í˜„ì¬ ì°¨ëŸ‰ë²ˆí˜¸</th>
            <th>í˜„ì¬ í˜¸ìˆ˜</th>
            <th>ì—…ë°ì´íŠ¸ í˜¸ìˆ˜</th>
            <th>ìƒíƒœ</th>
          </tr>
        </thead>
        <tbody id="previewTableBody">
        </tbody>
      </table>
    </div>
    <div class="modal-buttons">
      <button id="applyUpdateBtn" class="remove">ì ìš©</button>
      <button id="cancelUpdateBtn" class="cancel">ì·¨ì†Œ</button>
    </div>
  </div>

  <script>
    const TOTAL_SPOTS = 108;
    const DEFAULT_ACTIVE_SPOTS = [
      1, 8, 15, 22, 26, 29, 37, 42, 43, 48,
      49, 52, 54, 55, 57, 58, 60, 61, 63, 64,
      66, 67, 69, 70, 72, 73, 75, 76, 78, 79,
      81, 82, 85, 87, 91, 97, 103, 106, 108
    ];
    const PLATFORM_KEYWORDS = ['ì—¬ê¸°', 'ì•¼ë†€ì', 'íƒ€ì„', 'ë‚˜ìš°', 'ê¿€ìŠ¤', 'ì•„ê³ ë‹¤'];
    const VALID_ROOM_RANGES = [
      [201, 214],
      [301, 314],
      [501, 514],
      [601, 614],
      [701, 714]
    ];

    let parkingRecords = JSON.parse(localStorage.getItem("parkingRecords") || "{}");
    let activeSpots = JSON.parse(localStorage.getItem("activeSpots") || JSON.stringify(DEFAULT_ACTIVE_SPOTS));
    let isEditMode = false;
    let modalOpen = false;
    let currentSlot = null;
    let updateDataArr = [];
    let previewData = [];
    let allErrors = [];

    function updateStatus() {
      const occupiedCount = Object.keys(parkingRecords).length;
      const availableCount = activeSpots.length - occupiedCount;
      document.getElementById("status").innerText = `í˜„ì¬ ì£¼ì°¨ëœ ì°¨ëŸ‰: ${occupiedCount}ëŒ€ / ë‚¨ì€ ìë¦¬: ${availableCount}ëŒ€`;
    }

    function isValidRoomNumber(room) {
      const roomNum = parseInt(room);
      return VALID_ROOM_RANGES.some(([min, max]) => 
        roomNum >= min && roomNum <= max
      );
    }

    function isValidCarNumber(car) {
      return /^\d{4}$/.test(car);
    }

    function partsContain(parts, keyword) {
      return parts.some(p => p === keyword || p.includes(keyword));
    }

    // ë¶™ì—¬ë„£ê¸° ë°ì´í„° íŒŒì‹± ë° 1ì°¨ ê²€ì¦ (P/W ê·œì¹™)
    function parseAndValidateData(text) {
      const lines = text.trim().split('\n');
      const validData = [];
      const errors = [];

      // ì¤‘ë³µ ì²´í¬ìš©
      const carDupMap = new Map();
      const roomDupMap = new Map();

      // 1ì°¨ íŒŒì‹± ë° ì¤‘ë³µ ì²´í¬ ì¤€ë¹„
      const parsedLines = [];

      lines.forEach((line, idx) => {
        const parts = line.split(/\s+/);
        let roomNumber = parts[0] || '';
        let carData = parts.find(part => part.startsWith('ì°¨ëŸ‰:')) || '';
        let carNumber = carData ? carData.replace('ì°¨ëŸ‰:', '') : '';
        let data2 = parts[1] || '';
        let data3 = parts[2] || '';
        const isSpecialPlatform = PLATFORM_KEYWORDS.some(keyword => data2.includes(keyword));
        if (carNumber) carDupMap.set(carNumber, (carDupMap.get(carNumber)||0)+1);
        if (roomNumber) roomDupMap.set(roomNumber, (roomDupMap.get(roomNumber)||0)+1);
        parsedLines.push({roomNumber, carNumber, carData, data2, data3, isSpecialPlatform, parts, line, idx});
      });

      parsedLines.forEach((item) => {
        const {roomNumber, carNumber, carData, data2, data3, isSpecialPlatform, parts} = item;
        let hasError = false;
        // W15: ìœ íš¨í•˜ì§€ ì•Šì€ ì…ì‹¤ í˜¸ìˆ˜
        if (roomNumber && !isValidRoomNumber(roomNumber)) {
          errors.push(`[ì…ë ¥ëœ ì •ë³´] ì…ì‹¤ í˜¸ìˆ˜ ${roomNumber}í˜¸ëŠ” ìœ íš¨í•˜ì§€ ì•ŠëŠ” í˜¸ìˆ˜ì…ë‹ˆë‹¤.`);
          hasError = true;
        }
        // W1: ì°¨ëŸ‰ë²ˆí˜¸ í˜•ì‹ ì˜¤ë¥˜
        if (carNumber && !isValidCarNumber(carNumber)) {
          if (roomNumber) {
            errors.push(`[ì…ë ¥ëœ ì •ë³´] ì…ì‹¤ í˜¸ìˆ˜ ${roomNumber}í˜¸ ì°¨ëŸ‰ ë²ˆí˜¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
          } else if (isSpecialPlatform) {
            errors.push(`[ì…ë ¥ëœ ì •ë³´] '${data2}' ê³ ê°ë‹˜ì˜ ì°¨ëŸ‰ ë²ˆí˜¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
          } else {
            errors.push(`[ì…ë ¥ëœ ì •ë³´] '${data2} ${data3}' ê³ ê°ë‹˜ì˜ ì°¨ëŸ‰ ë²ˆí˜¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
          }
          hasError = true;
        }
        // W3: 'ì°¨ëŸ‰:ë„ë³´' ë˜ëŠ” 'ì°¨ëŸ‰:ë°–ì—ì£¼ì°¨'
        if (carData && (carNumber === 'ë„ë³´' || carNumber === 'ë°–ì—ì£¼ì°¨')) {
          if (roomNumber) {
            errors.push(`[ì…ë ¥ëœ ì •ë³´] ì…ì‹¤ í˜¸ìˆ˜ ${roomNumber}í˜¸ëŠ” ì°¨ëŸ‰ ì˜ˆì•½ì´ì§€ë§Œ ${carNumber === 'ë„ë³´' ? 'ë„ë³´ ë°©ë¬¸' : 'ë°–ì— ì£¼ì°¨ ê³ ê°'}ì…ë‹ˆë‹¤.`);
          } else if (isSpecialPlatform) {
            errors.push(`[ì…ë ¥ëœ ì •ë³´] '${data2}' ê³ ê°ë‹˜ì€ ì°¨ëŸ‰ ì˜ˆì•½ì´ì§€ë§Œ ${carNumber === 'ë„ë³´' ? 'ë„ë³´ ë°©ë¬¸' : 'ë°–ì— ì£¼ì°¨ ê³ ê°'}ì…ë‹ˆë‹¤.`);
          } else {
            errors.push(`[ì…ë ¥ëœ ì •ë³´] '${data2} ${data3}' ê³ ê°ë‹˜ì€ ì°¨ëŸ‰ ì˜ˆì•½ì´ì§€ë§Œ ${carNumber === 'ë„ë³´' ? 'ë„ë³´ ë°©ë¬¸' : 'ë°–ì— ì£¼ì°¨ ê³ ê°'}ì…ë‹ˆë‹¤.`);
          }
          hasError = true;
        }
        // W5: ë„ë³´ë§Œ ë‹¨ë… ì¡´ì¬
        if (!carData && partsContain(parts, 'ë„ë³´')) {
          if (roomNumber) {
            errors.push(`[ì…ë ¥ëœ ì •ë³´] ì…ì‹¤ í˜¸ìˆ˜ ${roomNumber}í˜¸ ê³ ê°ë‹˜ì€ ë„ë³´ ë°©ë¬¸ì…ë‹ˆë‹¤.`);
          } else if (isSpecialPlatform) {
            errors.push(`[ì…ë ¥ëœ ì •ë³´] '${data2}' ê³ ê°ë‹˜ì€ ë„ë³´ ë°©ë¬¸ì…ë‹ˆë‹¤.`);
          } else {
            errors.push(`[ì…ë ¥ëœ ì •ë³´] '${data2} ${data3}' ê³ ê°ë‹˜ì€ ë„ë³´ ë°©ë¬¸ì…ë‹ˆë‹¤.`);
          }
          hasError = true;
        }
        // W6: í•œ ì¤„ì— 'ë„ë³´'ì™€ 'ì°¨ëŸ‰:XXXX'ê°€ ê°™ì´ ìˆëŠ” ê²½ìš°
        if (carNumber && partsContain(parts, 'ë„ë³´')) {
          if (roomNumber) {
            errors.push(`[ì…ë ¥ëœ ì •ë³´] ì…ì‹¤ í˜¸ìˆ˜ ${roomNumber}í˜¸ ê³ ê°ë‹˜ì€ ë„ë³´ì™€ ì°¨ëŸ‰ ì •ë³´ê°€ ê°™ì´ ì¡´ì¬í•©ë‹ˆë‹¤.`);
          } else if (isSpecialPlatform) {
            errors.push(`[ì…ë ¥ëœ ì •ë³´] '${data2}' ê³ ê°ë‹˜ì€ ë„ë³´ì™€ ì°¨ëŸ‰ ì •ë³´ê°€ ê°™ì´ ì¡´ì¬í•©ë‹ˆë‹¤.`);
          } else {
            errors.push(`[ì…ë ¥ëœ ì •ë³´] '${data2} ${data3}' ê³ ê°ë‹˜ì€ ë„ë³´ì™€ ì°¨ëŸ‰ ì •ë³´ê°€ ê°™ì´ ì¡´ì¬í•©ë‹ˆë‹¤.`);
          }
          hasError = true;
        }
        // W7: í•œ ì¤„ì— ì°¨ëŸ‰ë²ˆí˜¸ê°€ 2ê°œ ì´ìƒ ì¡´ì¬
        if (parts.filter(p=>p.startsWith('ì°¨ëŸ‰:')).length > 1) {
          if (roomNumber) {
            errors.push(`[ì…ë ¥ëœ ì •ë³´] ì…ì‹¤ í˜¸ìˆ˜ ${roomNumber}í˜¸ì— ì°¨ëŸ‰ ë²ˆí˜¸ê°€ ì—¬ëŸ¬ ê°œ ì¡´ì¬í•©ë‹ˆë‹¤.`);
          } else if (isSpecialPlatform) {
            errors.push(`[ì…ë ¥ëœ ì •ë³´] '${data2}' ê³ ê°ë‹˜ì€ ì°¨ëŸ‰ ë²ˆí˜¸ê°€ ì—¬ëŸ¬ ê°œ ì¡´ì¬í•©ë‹ˆë‹¤.`);
          } else {
            errors.push(`[ì…ë ¥ëœ ì •ë³´] '${data2} ${data3}' ê³ ê°ë‹˜ì€ ì°¨ëŸ‰ ë²ˆí˜¸ê°€ ì—¬ëŸ¬ ê°œ ì¡´ì¬í•©ë‹ˆë‹¤.`);
          }
          hasError = true;
        }
        // W4: ì…ì‹¤ í˜¸ìˆ˜ ì—†ì´ 'ì°¨ëŸ‰' ë˜ëŠ” '-'ë§Œ ë‹¨ë… ì¡´ì¬
        if (!roomNumber && (partsContain(parts, 'ì°¨ëŸ‰') || partsContain(parts, '-'))) {
          if (isSpecialPlatform) {
            errors.push(`[ì…ë ¥ëœ ì •ë³´] '${data2}' ê³ ê°ë‹˜ì€ ì•„ì§ ë¯¸ë°©ë¬¸ì…ë‹ˆë‹¤.`);
          } else {
            errors.push(`[ì…ë ¥ëœ ì •ë³´] '${data2} ${data3}' ê³ ê°ë‹˜ì€ ì•„ì§ ë¯¸ë°©ë¬¸ì…ë‹ˆë‹¤.`);
          }
          hasError = true;
        }
        // W2: ì°¨ëŸ‰ë²ˆí˜¸ëŠ” ìˆëŠ”ë° ì…ì‹¤ í˜¸ìˆ˜ ì—†ìŒ
        if (carNumber && !roomNumber) {
          errors.push(`[ì…ë ¥ëœ ì •ë³´] ì°¨ëŸ‰ë²ˆí˜¸:${carNumber} ì°¨ëŸ‰ì€ ì•„ì§ ì²´í¬ì¸í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.(ê°ì‹¤ ë¯¸ë°°ì •)`);
          hasError = true;
        }
        // W16: ì…ì‹¤ í˜¸ìˆ˜ëŠ” ìˆëŠ”ë° ì°¨ëŸ‰ ì •ë³´ ëˆ„ë½
        if (roomNumber && (!carNumber || carNumber === '-' || carNumber === 'ì°¨ëŸ‰')) {
          errors.push(`[ì…ë ¥ëœ ì •ë³´] ì…ì‹¤ í˜¸ìˆ˜ ${roomNumber}í˜¸ì˜ ì£¼ì°¨ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          hasError = true;
        }
        // W9: ë¶™ì—¬ë„£ê¸° ë‚´ ì°¨ëŸ‰ë²ˆí˜¸ ì¤‘ë³µ
        if (carNumber && carDupMap.get(carNumber) > 1) {
          errors.push(`[ì…ë ¥ëœ ì •ë³´] ì°¨ëŸ‰ë²ˆí˜¸:${carNumber}ê°€ ì¤‘ë³µë©ë‹ˆë‹¤.`);
          hasError = true;
        }
        // W10: ë¶™ì—¬ë„£ê¸° ë‚´ ì…ì‹¤í˜¸ìˆ˜ ì¤‘ë³µ
        if (roomNumber && roomDupMap.get(roomNumber) > 1) {
          errors.push(`[ì…ë ¥ëœ ì •ë³´] ì…ì‹¤ í˜¸ìˆ˜ ${roomNumber}í˜¸ê°€ ì¤‘ë³µë©ë‹ˆë‹¤.`);
          hasError = true;
        }
        if (hasError) return;
        // ë°ì´í„° ìœ íš¨
        if (carNumber && roomNumber) {
          validData.push({roomNumber, carNumber, data2, data3, isSpecialPlatform, line: item.line});
        }
      });

      return { validData, errors };
    }

    // W8, W11, W12, W13 ì‹œìŠ¤í…œ-ë¶™ì—¬ë„£ê¸° ë°ì´í„° ë¹„êµ ë° previewData ìƒì„±
    function generatePreviewAndErrors(validData, parkingRecords, errors = []) {
      const previewData = [];
      // ì‹œìŠ¤í…œ ë°ì´í„°: ì°¨ëŸ‰ë²ˆí˜¸/í˜¸ì‹¤ ì¤‘ë³µ ì²´í¬ìš©
      const systemCarMap = new Map();
      const systemRoomMap = new Map();

      Object.values(parkingRecords).forEach(rec => {
        if (rec.car) systemCarMap.set(rec.car, (systemCarMap.get(rec.car)||0)+1);
        if (rec.room) systemRoomMap.set(rec.room, (systemRoomMap.get(rec.room)||0)+1);
      });

      // ë¶™ì—¬ë„£ê¸° ë°ì´í„° -> ì‹œìŠ¤í…œ ë°ì´í„° ë§¤ì¹­ ë° W8 ì²˜ë¦¬
      validData.forEach(({carNumber, roomNumber}) => {
        // ì‹œìŠ¤í…œì— ë™ì¼ ì°¨ëŸ‰ë²ˆí˜¸ê°€ ìˆë‚˜?
        const slot = Object.keys(parkingRecords).find(s => parkingRecords[s].car === carNumber);
        const sysRoom = slot ? parkingRecords[slot].room : undefined;
        // W8: ë¶™ì—¬ë„£ê¸° ë°ì´í„°ì™€ ì‹œìŠ¤í…œ ë°ì´í„° ë¶ˆì¼ì¹˜
        if (slot) {
          if (sysRoom && sysRoom !== roomNumber) {
            errors.push(`[ì…ë ¥ëœ ì •ë³´] ì°¨ëŸ‰ ë²ˆí˜¸:${carNumber}ì˜ ì…ì‹¤ í˜¸ìˆ˜ê°€ ì‹œíŠ¸ ì •ë³´ì™€ ì‹œìŠ¤í…œê³¼ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
            previewData.push({
              slot, currentCar: carNumber, currentRoom: sysRoom, newRoom: roomNumber, status: "ì…ì‹¤í˜¸ìˆ˜ ë¶ˆì¼ì¹˜"
            });
            return;
          }
          if (roomNumber && sysRoom === roomNumber) {
            previewData.push({
              slot, currentCar: carNumber, currentRoom: sysRoom, newRoom: roomNumber, status: "ë™ì¼"
            });
            return;
          }
        }
        // ì‹œìŠ¤í…œì— ë™ì¼ ì…ì‹¤í˜¸ìˆ˜ê°€ ìˆë‚˜?
        const slotByRoom = Object.keys(parkingRecords).find(s => parkingRecords[s].room === roomNumber);
        const sysCar = slotByRoom ? parkingRecords[slotByRoom].car : undefined;
        if (slotByRoom && sysCar && sysCar !== carNumber) {
          errors.push(`[ì…ë ¥ëœ ì •ë³´] ì…ì‹¤ í˜¸ìˆ˜ ${roomNumber}í˜¸ì˜ ì°¨ëŸ‰ ë²ˆí˜¸ê°€ ì‹œíŠ¸ ì •ë³´ì™€ ì‹œìŠ¤í…œê³¼ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
          previewData.push({
            slot: slotByRoom, currentCar: sysCar, currentRoom: roomNumber, newRoom: roomNumber, status: "ì°¨ëŸ‰ë²ˆí˜¸ ë¶ˆì¼ì¹˜"
          });
          return;
        }
        // ì •ìƒ ë§¤ì¹­
        if (slot) {
          previewData.push({
            slot, currentCar: carNumber, currentRoom: sysRoom, newRoom: roomNumber, status: "ì—…ë°ì´íŠ¸"
          });
        }
      });

      // W11: ì‹œìŠ¤í…œ ë‚´ ì°¨ëŸ‰ë²ˆí˜¸ ì¤‘ë³µ
      for (const [car, count] of systemCarMap) {
        if (count > 1) errors.push(`[ì‹œìŠ¤í…œ ì •ë³´] ì°¨ëŸ‰ë²ˆí˜¸:${car}ê°€ ì¤‘ë³µë©ë‹ˆë‹¤.`);
      }
      // W12: ì‹œìŠ¤í…œ ë‚´ ì…ì‹¤í˜¸ìˆ˜ ì¤‘ë³µ
      for (const [room, count] of systemRoomMap) {
        if (count > 1) errors.push(`[ì‹œìŠ¤í…œ ì •ë³´] ì…ì‹¤ í˜¸ìˆ˜ ${room}í˜¸ê°€ ì¤‘ë³µë©ë‹ˆë‹¤.`);
      }
      // W13: ì‹œìŠ¤í…œì—ëŠ” ìˆëŠ”ë° ë¶™ì—¬ë„£ê¸°ì— ì—†ëŠ” ê²½ìš°(ë¯¸ë“±ë¡)
      const pasteCarSet = new Set(validData.map(d=>d.carNumber));
      const pasteRoomSet = new Set(validData.map(d=>d.roomNumber));
      Object.entries(parkingRecords).forEach(([slot, rec]) => {
        if (rec.car && !pasteCarSet.has(rec.car)) {
          errors.push(`[ì‹œìŠ¤í…œ ì •ë³´] ì°¨ëŸ‰ë²ˆí˜¸:${rec.car}ì˜ ì°¨ëŸ‰ì€ ì£¼ì°¨ ë¯¸ë“±ë¡ ì°¨ëŸ‰ì…ë‹ˆë‹¤.(ì™¸ë¶€ ì°¨ëŸ‰ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)`);
        }
        if (rec.room && !pasteRoomSet.has(rec.room)) {
          errors.push(`[ì‹œìŠ¤í…œ ì •ë³´] ì…ì‹¤ í˜¸ìˆ˜ ${rec.room}í˜¸ ì°¨ëŸ‰ì€ ì£¼ì°¨ ë¯¸ë“±ë¡ ì°¨ëŸ‰ì…ë‹ˆë‹¤.(ì™¸ë¶€ ì°¨ëŸ‰ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.)`);
        }
      });

      return { previewData, errors };
    }

    // --- ì—ëŸ¬ ë©”ì‹œì§€ ë¶„ë¥˜ ë° ê·¸ë£¹í•‘ ê¸°ëŠ¥ ì¶”ê°€ ---
    function classifyError(msg) {
      if (
        msg.includes('í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤') ||
        msg.includes('ìœ íš¨í•˜ì§€ ì•ŠëŠ” í˜¸ìˆ˜')
      ) return 'í˜•ì‹ ì˜¤ë¥˜';
      if (
        msg.includes('ëˆ„ë½') ||
        msg.includes('ë¯¸ë°©ë¬¸') ||
        msg.includes('ë¯¸ë°°ì •')
      ) return 'ëˆ„ë½/ë¯¸ë°©ë¬¸';
      if (
        msg.includes('ë„ë³´') ||
        msg.includes('ë°–ì— ì£¼ì°¨') ||
        msg.includes('ë°–ì— ì£¼ì°¨ ê³ ê°')
      ) return 'íŠ¹ìˆ˜ìƒí™©';
      if (msg.includes('ì¤‘ë³µ')) return 'ì¤‘ë³µ';
      if (msg.includes('ë¶ˆì¼ì¹˜')) return 'ë¶ˆì¼ì¹˜';
      if (msg.includes('ë¯¸ë“±ë¡')) return 'ë¯¸ë“±ë¡';
      return 'ê¸°íƒ€';
    }

    function groupErrorsByCategory(errors) {
      const categoryMap = {};
      errors.forEach(msg => {
        const cat = classifyError(msg);
        if (!categoryMap[cat]) categoryMap[cat] = [];
        categoryMap[cat].push(msg);
      });
      return categoryMap;
    }

    // --- ì¤‘ë³µ ì—ëŸ¬ ë©”ì‹œì§€ í•„í„°ë§ ---
    function filterDuplicateErrors(errors) {
      // ë¬¸ìì—´ ê¸°ì¤€ìœ¼ë¡œ ì™„ì „ ì¤‘ë³µ ì œê±°
      return Array.from(new Set(errors));
    }

    function showModal(slot) {
      modalOpen = true;
      currentSlot = slot;
      const modal = document.getElementById("modal");
      modal.style.display = "block";

      const roomInput = document.getElementById("room");
      const carInput = document.getElementById("car");
      roomInput.value = parkingRecords[slot]?.room || "";
      carInput.value = parkingRecords[slot]?.car || "";

      document.getElementById("submitBtn").onclick = () => {
        const room = roomInput.value;
        const car = carInput.value;
        parkingRecords[slot] = { room, car };
        const spotElement = document.getElementById(`spot-${slot}`);
        spotElement.classList.add("occupied");
        spotElement.innerText = `${room || "-"}\n${car || "-"}`;
        updateStatus();
        localStorage.setItem("parkingRecords", JSON.stringify(parkingRecords));
        modal.style.display = "none";
        modalOpen = false;
      };

      document.getElementById("removeBtn").onclick = () => {
        delete parkingRecords[slot];
        const spotElement = document.getElementById(`spot-${slot}`);
        spotElement.classList.remove("occupied");
        spotElement.innerText = "";
        updateStatus();
        localStorage.setItem("parkingRecords", JSON.stringify(parkingRecords));
        modal.style.display = "none";
        modalOpen = false;
      };

      document.getElementById("cancelBtn").onclick = () => {
        modal.style.display = "none";
        modalOpen = false;
      };
    }

    function toggleEditMode() {
      isEditMode = !isEditMode;
      document.getElementById("resetToDefaultBtn").style.display = isEditMode ? "inline-block" : "none";
      document.getElementById("parkingLot").classList.toggle("edit-mode", isEditMode);
    }

    function resetToDefaultSpots() {
      activeSpots = [...DEFAULT_ACTIVE_SPOTS];
      parkingRecords = {};
      localStorage.setItem("activeSpots", JSON.stringify(activeSpots));
      localStorage.setItem("parkingRecords", JSON.stringify(parkingRecords));
      createParkingLot();
    }

    function toggleParking(slot) {
      if (modalOpen) return;
      if (isEditMode) {
        const index = activeSpots.indexOf(slot);
        if (index === -1) {
          activeSpots.push(slot);
        } else {
          activeSpots.splice(index, 1);
          delete parkingRecords[slot];
        }
        localStorage.setItem("activeSpots", JSON.stringify(activeSpots));
        localStorage.setItem("parkingRecords", JSON.stringify(parkingRecords));
        createParkingLot();
      } else {
        if (activeSpots.includes(slot)) {
          showModal(slot);
        }
      }
    }

    async function handlePaste() {
      try {
        const text = await navigator.clipboard.readText();
        const { validData, errors } = parseAndValidateData(text);
        // W8, W11~W13ê¹Œì§€ ë°˜ì˜
        const { previewData: newPreviewData, errors: allErr } = generatePreviewAndErrors(validData, parkingRecords, errors);
        updateDataArr = validData;
        previewData = newPreviewData;
        // --- ì¤‘ë³µ ë©”ì‹œì§€ í•„í„°ë§ ì ìš© ---
        allErrors = filterDuplicateErrors(allErr);
        showPreviewModal(allErrors, previewData);
      } catch (err) {
        alert('í´ë¦½ë³´ë“œ ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        console.error('í´ë¦½ë³´ë“œ ì—ëŸ¬:', err);
      }
    }

    function showPreviewModal(errors, previewData) {
      const modal = document.getElementById('previewModal');
      const tableBody = document.getElementById('previewTableBody');
      const totalCount = updateDataArr.length;
      const matchCount = previewData.length;

      document.getElementById('totalCount').textContent = totalCount;
      document.getElementById('matchCount').textContent = matchCount;

      // ì—ëŸ¬ ë©”ì‹œì§€ ì˜ì—­ ì´ˆê¸°í™”
      const existingErrorList = document.querySelector('.error-list');
      if (existingErrorList) {
        existingErrorList.remove();
      }

      // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ (ì¹´í…Œê³ ë¦¬ë³„ ê·¸ë£¹í•‘)
      if (errors.length > 0) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-list';

        const grouped = groupErrorsByCategory(errors);
        Object.entries(grouped).forEach(([cat, msgs]) => {
          const details = document.createElement('details');
          details.open = false;
          const summary = document.createElement('summary');
          summary.textContent = `${cat} (${msgs.length})`;
          details.appendChild(summary);
          msgs.forEach(m => {
            const div = document.createElement('div');
            div.textContent = m;
            details.appendChild(div);
          });
          errorDiv.appendChild(details);
        });
        document.getElementById('previewContent').insertBefore(
          errorDiv,
          document.getElementById('previewContent').firstChild
        );
      }

      tableBody.innerHTML = previewData.map(item => `
        <tr>
          <td>${item.slot}</td>
          <td>${item.currentCar}</td>
          <td>${item.currentRoom}</td>
          <td>${item.newRoom}</td>
          <td>${item.status}</td>
        </tr>
      `).join('');

      modal.style.display = 'block';
    }

    function applyUpdate() {
      let updateCount = 0;

      previewData.forEach(item => {
        parkingRecords[item.slot] = {
          car: item.currentCar,
          room: item.newRoom
        };

        const spotElement = document.getElementById(`spot-${item.slot}`);
        if (spotElement) {
          spotElement.innerText = `${item.newRoom}\n${item.currentCar}`;
        }
        updateCount++;
      });

      localStorage.setItem('parkingRecords', JSON.stringify(parkingRecords));
      updateStatus();
      document.getElementById('previewModal').style.display = 'none';
      alert(`ì´ ${updateCount}ê°œì˜ ì£¼ì°¨ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }

    function createParkingLot() {
      const lot = document.getElementById("parkingLot");
      lot.innerHTML = "";

      const linesBottom = [60, 70, 69, 81, 61, 73, 85, 97, 52];
      const linesTop = [66, 76, 75, 87, 67, 79, 91, 103, 58];

      for (let i = 1; i <= TOTAL_SPOTS; i++) {
        const spot = document.createElement("div");
        spot.classList.add("spot");

        if (!activeSpots.includes(i)) {
          spot.classList.add("empty");
        } else {
          spot.classList.add("active");
          spot.id = `spot-${i}`;
          if (parkingRecords[i]) {
            spot.classList.add("occupied");
            spot.innerText = `${parkingRecords[i].room || "-"}\n${parkingRecords[i].car || "-"}`;
          }
        }

        if (linesBottom.includes(i)) spot.classList.add("border-bottom");
        if (linesTop.includes(i)) spot.classList.add("border-top");

        spot.onclick = () => toggleParking(i);
        lot.appendChild(spot);
      }
      updateStatus();
    }

    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('editModeBtn').onclick = toggleEditMode;
      document.getElementById('resetToDefaultBtn').onclick = resetToDefaultSpots;
      document.getElementById('clearAllBtn').onclick = () => {
        parkingRecords = {};
        localStorage.setItem('parkingRecords', JSON.stringify(parkingRecords));
        createParkingLot();
      };
      document.getElementById('pasteIcon').onclick = handlePaste;
      document.getElementById('applyUpdateBtn').onclick = applyUpdate;
      document.getElementById('cancelUpdateBtn').onclick = () => {
        document.getElementById('previewModal').style.display = 'none';
      };

      createParkingLot();
    });
  </script>
</body>
</html>
