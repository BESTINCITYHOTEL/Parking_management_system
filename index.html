<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>주차 관리 시스템</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 10px;
    }
    h2 {
      text-align: center;
    }
    .top-buttons {
      margin-bottom: 10px;
      text-align: center;
    }
    .top-buttons button {
      margin: 0 5px;
      font-size: 20px;
      cursor: pointer;
    }
    #status {
      margin-bottom: 10px;
      text-align: center;
      font-weight: bold;
    }
    .parking-container {
      display: grid;
      grid-template-columns: repeat(12, 50px);
      gap: 5px;
      justify-content: center;
      user-select: none;
    }
    .spot {
      width: 50px;
      height: 50px;
      border: 1px solid #333;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 11px;
      cursor: pointer;
      white-space: pre-line;
      background-color: #e0e0e0;
      border-radius: 4px;
    }
    .spot.occupied {
      background-color: #9acd32;
      color: #000;
      font-weight: bold;
    }
    .spot.empty {
      background-color: #f8f8f8;
      border-color: #ccc;
      cursor: default;
    }
    .spot.active:hover {
      background-color: #7fbf7f;
    }
    .spot.border-bottom {
      border-bottom: 3px solid #333;
    }
    .spot.border-top {
      border-top: 3px solid #333;
    }
    .edit-mode .spot {
      cursor: pointer;
    }
    .modal, .preview-modal {
      display: none;
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border: 2px solid #333;
      border-radius: 6px;
      padding: 15px;
      z-index: 1000;
      width: 350px;
      max-width: 90%;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .modal h3, .preview-modal h3 {
      margin-top: 0;
      text-align: center;
    }
    .modal input {
      width: calc(50% - 12px);
      margin: 5px 5px 15px 5px;
      padding: 6px;
      font-size: 14px;
    }
    .modal-buttons {
      display: flex;
      justify-content: space-between;
    }
    .modal-buttons button {
      flex: 1;
      margin: 0 5px;
      padding: 8px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 4px;
      border: none;
    }
    .modal-buttons button.remove {
      background-color: #f44336;
      color: #fff;
    }
    .modal-buttons button.cancel {
      background-color: #9e9e9e;
      color: #fff;
    }
    .modal-buttons button:not(.remove):not(.cancel) {
      background-color: #4caf50;
      color: #fff;
    }
    .preview-summary {
      margin-bottom: 10px;
      text-align: center;
      font-weight: bold;
    }
    .preview-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-bottom: 10px;
    }
    .preview-table th, .preview-table td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    .error-list {
      margin-bottom: 10px;
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid #f44336;
      background-color: #ffe6e6;
      padding: 8px;
      border-radius: 4px;
      font-size: 12px;
      color: #a94442;
    }
    .error-list details summary {
      cursor: pointer;
      font-weight: bold;
    }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>
</head>
<body>
  <h2>주차 관리 시스템</h2>
  <div class="top-buttons">
    <button id="undoBtn">↩️</button>
    <button id="redoBtn">↪️</button>
    <button id="clearAllBtn">🧹</button>
    <button id="editModeBtn">🚗</button>
    <button id="pasteIcon">📋</button>
    <button id="resetToDefaultBtn" style="display:none">🔄</button>
  </div>
  <p id="status">현재 주차된 차량: 0대 / 남은 자리: 39대</p>
  <div class="parking-container" id="parkingLot"></div>

  <div id="modal" class="modal">
    <h3>주차 정보 수정</h3>
    <input type="text" id="room" placeholder="입실 호수" inputmode="numeric" />
    <input type="text" id="car" placeholder="차량 뒷번호" inputmode="numeric" />
    <div class="modal-buttons">
      <button class="remove" id="removeBtn">출차</button>
      <button id="submitBtn">저장</button>
      <button class="cancel" id="cancelBtn">취소</button>
    </div>
  </div>

  <div id="previewModal" class="preview-modal">
    <h3>데이터 업데이트 미리보기</h3>
    <div class="preview-summary">
      <p>총 <span id="totalCount">0</span>개의 데이터 중 <span id="matchCount">0</span>개 매칭됨</p>
    </div>
    <div id="previewContent">
      <table class="preview-table">
        <thead>
          <tr>
            <th>주차 위치</th>
            <th>현재 차량번호</th>
            <th>현재 호수</th>
            <th>업데이트 호수</th>
            <th>상태</th>
          </tr>
        </thead>
        <tbody id="previewTableBody"></tbody>
      </table>
    </div>
    <div class="modal-buttons">
      <button id="applyUpdateBtn" class="remove">적용</button>
      <button id="cancelUpdateBtn" class="cancel">취소</button>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCU6-7mf38_E026iIYgJtlAbnNaSVe7rmM",
      authDomain: "parking-management-syste-64f15.firebaseapp.com",
      projectId: "parking-management-syste-64f15",
      storageBucket: "parking-management-syste-64f15.firebasestorage.app",
      messagingSenderId: "767840329602",
      appId: "1:767840329602:web:2631eb2b2efafee6dcf99b",
      measurementId: "G-ZFKFS8Y7N7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const TOTAL_SPOTS = 108;
    const DEFAULT_ACTIVE_SPOTS = [
      1, 8, 15, 22, 26, 29, 37, 42, 43, 48,
      49, 52, 54, 55, 57, 58, 60, 61, 63, 64,
      66, 67, 69, 70, 72, 73, 75, 76, 78, 79,
      81, 82, 85, 87, 91, 97, 103, 106, 108
    ];
    const PLATFORM_KEYWORDS = ['여기', '야놀자', '타임', '나우', '꿀스', '아고다'];
    const VALID_ROOM_RANGES = [
      [201, 214],
      [301, 314],
      [501, 514],
      [601, 614],
      [701, 714]
    ];

    let parkingRecords = {};
    let activeSpots = [];
    let isEditMode = false;
    let modalOpen = false;
    let currentSlot = null;
    let updateDataArr = [];
    let previewData = [];
    let allErrors = [];

    const undoRef = db.ref('undoStack');
    const redoRef = db.ref('redoStack');

    let historyStack = [];
    let redoStack = [];

    let firebaseReady = false;

    undoRef.on('value', snapshot => {
      const val = snapshot.val();
      historyStack = val
        ? Object.entries(val).map(([key, value]) => ({ key, ...value }))
        : [];
    });

    redoRef.on('value', snapshot => {
      const val = snapshot.val();
      redoStack = val
        ? Object.entries(val).map(([key, value]) => ({ key, ...value }))
        : [];
    });

    function loadFirebaseData() {
      db.ref('activeSpots').once('value').then(snapshot => {
        activeSpots = snapshot.val() || [...DEFAULT_ACTIVE_SPOTS];
        firebaseReady = true;
        createParkingLot();
      });
      db.ref('parkingRecords').once('value').then(snapshot => {
        parkingRecords = snapshot.val() || {};
        firebaseReady = true;
        createParkingLot();
      });
    }

    db.ref('activeSpots').on('value', snapshot => {
      activeSpots = snapshot.val() || [...DEFAULT_ACTIVE_SPOTS];
      createParkingLot();
    });

    db.ref('parkingRecords').on('value', snapshot => {
      parkingRecords = snapshot.val() || {};
      createParkingLot();
    });

    function saveParkingRecords() {
      db.ref('parkingRecords').set(parkingRecords);
    }
    function saveActiveSpots() {
      db.ref('activeSpots').set(activeSpots);
    }

    function saveHistory() {
      const snapshot = {
        parkingRecords: JSON.parse(JSON.stringify(parkingRecords)),
        activeSpots: JSON.parse(JSON.stringify(activeSpots)),
        timestamp: Date.now()
      };
      undoRef.push(snapshot);
      redoRef.set(null);
    }

    function undo() {
      if (historyStack.length === 0) return;

      const last = historyStack[historyStack.length - 1];

      const current = {
        parkingRecords: JSON.parse(JSON.stringify(parkingRecords)),
        activeSpots: JSON.parse(JSON.stringify(activeSpots)),
        timestamp: Date.now()
      };
      redoRef.push(current);

      undoRef.child(last.key).remove();

      parkingRecords = last.parkingRecords;
      activeSpots = last.activeSpots;

      saveParkingRecords();
      saveActiveSpots();
      createParkingLot();
    }

    function redo() {
      if (redoStack.length === 0) return;

      const last = redoStack[redoStack.length - 1];

      const current = {
        parkingRecords: JSON.parse(JSON.stringify(parkingRecords)),
        activeSpots: JSON.parse(JSON.stringify(activeSpots)),
        timestamp: Date.now()
      };
      undoRef.push(current);

      redoRef.child(last.key).remove();

      parkingRecords = last.parkingRecords;
      activeSpots = last.activeSpots;

      saveParkingRecords();
      saveActiveSpots();
      createParkingLot();
    }
    
    function updateStatus() {
      const occupiedCount = Object.keys(parkingRecords).length;
      const availableCount = activeSpots.length - occupiedCount;
      document.getElementById("status").innerText = `현재 주차된 차량: ${occupiedCount}대 / 남은 자리: ${availableCount}대`;
    }
    function isValidRoomNumber(room) {
      if (room === "" || room === undefined) return true;
      const roomNum = parseInt(room, 10);
      if (isNaN(roomNum)) return false;
      return VALID_ROOM_RANGES.some(([min, max]) => roomNum >= min && roomNum <= max);
    }
    function isValidCarNumber(car) {
      return /^\d{4}$/.test(car);
    }
    function partsContain(parts, keyword) {
      return parts.some(p => p === keyword || p.includes(keyword));
    }
    function parseLine13(line) {
      let parts = line.split('\t');
      if (parts.length === 1) {
        parts = line.split(/ {2,}/);
      }
      if (parts.length === 12) {
        parts.unshift("");
      }
      return parts;
    }

    function parseAndValidateData(text) {
      const allPasteCarNumbers = new Set();
      const allPasteRoomNumbers = new Set();
      const lines = text.trim().split('\n');
      const validData = [];
      const errors = [];
      const carDupMap = new Map();
      const roomDupMap = new Map();
      const parsedLines = [];
      lines.forEach((line, idx) => {
        const parts = parseLine13(line);
        const carDataList = parts.filter(part => part.startsWith('차량:'));
        const carNumbers = carDataList.map(c => c.replace('차량:', ''));
        carNumbers.forEach(num => {
          if (num) allPasteCarNumbers.add(num);
        });
        const roomNumber = parts[0] ? parts[0].trim() : "";
        if (roomNumber) allPasteRoomNumbers.add(roomNumber);
        const carData = carDataList.length > 0 ? carDataList[0] : '';
        const carNumber = carNumbers.length > 0 ? carNumbers[0] : '';
        const data2 = parts[1] !== undefined ? parts[1].trim() : "";
        const data3 = parts[2] !== undefined ? parts[2].trim() : "";
        const isSpecialPlatform = !!data2 && PLATFORM_KEYWORDS.some(keyword => data2.includes(keyword));
        if (carNumber) carDupMap.set(carNumber, (carDupMap.get(carNumber)||0)+1);
        if (roomNumber) roomDupMap.set(roomNumber, (roomDupMap.get(roomNumber)||0)+1);
        parsedLines.push({roomNumber, carNumber, carData, carDataList, carNumbers, data2, data3, isSpecialPlatform, parts, line, idx});
      });
      parsedLines.forEach((item) => {
        const {roomNumber, carNumber, carData, carDataList, carNumbers, data2, data3, isSpecialPlatform, parts} = item;
        let hasError = false;
        const nameField = [data2, data3].filter(Boolean).join(' ').trim();
        const hasDobo = partsContain(parts, '도보');
        const hasCar = carDataList.length > 0;
        const isCarDobo = carData === '차량:도보';
        const isCarBake = carData === '차량:밖에주차';
        const lineNo = item.idx + 1;
        if (roomNumber && !isValidRoomNumber(roomNumber)) {
          errors.push(`[${lineNo}행] [입력된 정보] 입실 호수 ${roomNumber}호는 유효하지 않는 호수입니다.`);
          hasError = true;
        }
        carNumbers.forEach(carNum => {
          if (
            carNum && carNum !== '도보' && carNum !== '밖에주차' && !isValidCarNumber(carNum)
          ) {
            if (roomNumber) {
              errors.push(`[${lineNo}행] [입력된 정보] 입실 호수 ${roomNumber}호 차량 번호 형식이 올바르지 않습니다.`);
            } else if (isSpecialPlatform) {
              errors.push(`[${lineNo}행] [입력된 정보] ${data2} 고객님의 차량 번호 형식이 올바르지 않습니다.`);
            } else {
              errors.push(`[${lineNo}행] [입력된 정보] ${nameField} 고객님의 차량 번호 형식이 올바르지 않습니다.`);
            }
            hasError = true;
          }
        });
        if (
          carData && (isCarDobo || isCarBake)
        ) {
          if (roomNumber) {
            errors.push(`[${lineNo}행] [입력된 정보] 입실 호수 ${roomNumber}호는 차량 예약이지만 ${carNumber === '도보' ? '도보 방문' : '밖에 주차 고객'}입니다.`);
          } else if (isSpecialPlatform) {
            errors.push(`[${lineNo}행] [입력된 정보] ${data2} 고객님은 차량 예약이지만 ${carNumber === '도보' ? '도보 방문' : '밖에 주차 고객'}입니다.`);
          } else {
            errors.push(`[${lineNo}행] [입력된 정보] ${nameField} 고객님은 차량 예약이지만 ${carNumber === '도보' ? '도보 방문' : '밖에 주차 고객'}입니다.`);
          }
          hasError = true;
        }
        if (!carData && hasDobo) {
          if (roomNumber) {
            errors.push(`[${lineNo}행] [입력된 정보] 입실 호수 ${roomNumber}호 고객님은 도보 방문입니다.`);
          } else if (isSpecialPlatform) {
            errors.push(`[${lineNo}행] [입력된 정보] ${data2} 고객님은 도보 방문입니다.`);
          } else {
            errors.push(`[${lineNo}행] [입력된 정보] ${nameField} 고객님은 도보 방문입니다.`);
          }
          hasError = true;
        }
        if (
          hasDobo && hasCar && !isCarDobo && !isCarBake
        ) {
          if (roomNumber) {
            errors.push(`[${lineNo}행] [입력된 정보] 입실 호수 ${roomNumber}호 고객님은 도보와 차량 정보가 같이 존재합니다.`);
          } else if (isSpecialPlatform) {
            errors.push(`[${lineNo}행] [입력된 정보] ${data2} 고객님은 도보와 차량 정보가 같이 존재합니다.`);
          } else {
            errors.push(`[${lineNo}행] [입력된 정보] ${nameField} 고객님은 도보와 차량 정보가 같이 존재합니다.`);
          }
          hasError = true;
        }
        carNumbers.forEach(carNum => {
          if (
            carNum && !roomNumber && carNum !== '도보' && carNum !== '밖에주차'
          ) {
            errors.push(`[${lineNo}행] [입력된 정보] 차량번호:${carNum} 차량은 아직 체크인하지 않았습니다.(객실 미배정)`);
          }
        });
        if (carDataList.length > 1) {
          if (roomNumber) {
            errors.push(`[${lineNo}행] [입력된 정보] 입실 호수 ${roomNumber}호에 차량 번호가 여러 개 존재합니다.`);
          } else if (isSpecialPlatform) {
            errors.push(`[${lineNo}행] [입력된 정보] ${data2} 고객님은 차량 번호가 여러 개 존재합니다.`);
          } else {
            errors.push(`[${lineNo}행] [입력된 정보] ${nameField} 고객님은 차량 번호가 여러 개 존재합니다.`);
          }
          hasError = true;
        }
        if (
          !roomNumber &&
          (parts.includes('차량') || parts.includes('-'))
        ) {
          if (isSpecialPlatform) {
            errors.push(`[${lineNo}행] [입력된 정보] ${data2} 고객님은 아직 미방문입니다.`);
          } else {
            errors.push(`[${lineNo}행] [입력된 정보] ${nameField} 고객님은 아직 미방문입니다.`);
          }
          hasError = true;
        }
        if (carNumber && !roomNumber) {
          if ((carData === '차량:도보' || carData === '차량:밖에주차')) {
            if (isSpecialPlatform) {
              errors.push(`[${lineNo}행] [입력된 정보] ${data2} 고객님은 아직 체크인하지 않았습니다.(객실 미배정)`);
            } else {
              errors.push(`[${lineNo}행] [입력된 정보] ${[data2, data3].filter(Boolean).join(' ').trim()} 고객님은 아직 체크인하지 않았습니다.(객실 미배정)`);
            }
          }
          hasError = true;
        }
        if (
          roomNumber &&
          (!carNumber || carNumber === '-' || carNumber === '차량') &&
          !hasDobo
        ) {
          errors.push(`[${lineNo}행] [입력된 정보] 입실 호수 ${roomNumber}호의 주차 정보가 누락되었습니다.`);
          hasError = true;
        }
        if (carNumber && carDupMap.get(carNumber) > 1) {
          if (carNumber !== "도보" && carNumber !== "밖에주차") {
            errors.push(`[${lineNo}행] [입력된 정보] 차량번호:${carNumber}가 중복됩니다.`);
            hasError = true;
          }
        }
        if (roomNumber && roomDupMap.get(roomNumber) > 1) {
          errors.push(`[${lineNo}행] [입력된 정보] 입실 호수 ${roomNumber}호가 중복됩니다.`);
          hasError = true;
        }
        if (hasError) return;
        if (carNumber && roomNumber) {
          validData.push({roomNumber, carNumber, data2, data3, isSpecialPlatform, line: item.line});
        }
      });
      return { validData, errors, allPasteCarNumbers, allPasteRoomNumbers };
    }
    function generatePreviewAndErrors(validData, parkingRecords, errors = [], allPasteCarNumbers = new Set(), allPasteRoomNumbers = new Set()) {
      const previewData = [];
      const systemCarMap = new Map();
      const systemRoomMap = new Map();
      Object.values(parkingRecords).forEach(rec => {
        if (rec.car) systemCarMap.set(rec.car, (systemCarMap.get(rec.car)||0)+1);
        if (rec.room) systemRoomMap.set(rec.room, (systemRoomMap.get(rec.room)||0)+1);
      });
      validData.forEach(({carNumber, roomNumber}) => {
        const slot = Object.keys(parkingRecords).find(s => parkingRecords[s].car === carNumber);
        const sysRoom = slot ? parkingRecords[slot].room : undefined;
        if (slot) {
          if (sysRoom && sysRoom !== roomNumber) {
            errors.push(`[입력된 정보] 차량 번호:${carNumber}의 입실 호수가 시트 정보와 시스템과 일치하지 않습니다.`);
            previewData.push({
              slot, currentCar: carNumber, currentRoom: sysRoom, newRoom: roomNumber, status: "입실호수 불일치"
            });
            return;
          }
          if (roomNumber && sysRoom === roomNumber) {
            previewData.push({
              slot, currentCar: carNumber, currentRoom: sysRoom, newRoom: roomNumber, status: "동일"
            });
            return;
          }
        }
        const slotByRoom = Object.keys(parkingRecords).find(s => parkingRecords[s].room === roomNumber);
        const sysCar = slotByRoom ? parkingRecords[slotByRoom].car : undefined;
        if (slotByRoom && sysCar && sysCar !== carNumber) {
          errors.push(`[입력된 정보] 입실 호수 ${roomNumber}호의 차량 번호가 시트 정보와 시스템과 일치하지 않습니다.`);
          previewData.push({
            slot: slotByRoom, currentCar: sysCar, currentRoom: roomNumber, newRoom: roomNumber, status: "차량번호 불일치"
          });
          return;
        }
        if (slot) {
          previewData.push({
            slot, currentCar: carNumber, currentRoom: sysRoom, newRoom: roomNumber, status: "업데이트"
          });
        }
      });
      for (const [car, count] of systemCarMap) {
        if (count > 1) errors.push(`[시스템 정보] 차량번호:${car}가 중복됩니다.`);
      }
      for (const [room, count] of systemRoomMap) {
        if (count > 1) errors.push(`[시스템 정보] 입실 호수 ${room}호가 중복됩니다.`);
      }
      Object.entries(parkingRecords).forEach(([slot, rec]) => {
        if (rec.car && !allPasteCarNumbers.has(rec.car)) {
          errors.push(`[시스템 정보] 차량번호:${rec.car}의 차량은 주차 미등록 차량입니다.(외부 차량일 수 있습니다.)`);
        }
        if (rec.room && !allPasteRoomNumbers.has(rec.room)) {
          errors.push(`[시스템 정보] 입실 호수 ${rec.room}호 차량은 주차 미등록 차량입니다.(외부 차량일 수 있습니다.)`);
        }
      });
      return { previewData, errors };
    }
    function classifyError(msg) {
      if (
        msg.includes('형식이 올바르지 않습니다') ||
        msg.includes('유효하지 않는 호수')
      ) return '형식 오류';
      if (
        msg.includes('누락') ||
        msg.includes('미방문') ||
        msg.includes('미배정')
      ) return '누락/미방문';
      if (
        msg.includes('도보') ||
        msg.includes('밖에 주차') ||
        msg.includes('밖에 주차 고객')
      ) return '특수상황';
      if (msg.includes('중복')) return '중복';
      if (msg.includes('불일치')) return '불일치';
      if (msg.includes('미등록')) return '미등록';
      return '기타';
    }
    function groupErrorsByCategory(errors) {
      const categoryMap = {};
      errors.forEach(msg => {
        const cat = classifyError(msg);
        if (!categoryMap[cat]) categoryMap[cat] = [];
        categoryMap[cat].push(msg);
      });
      return categoryMap;
    }
    function filterDuplicateErrors(errors) {
      return Array.from(new Set(errors)).filter(msg =>
        !msg.includes("차량번호:도보가 중복됩니다.") &&
        !msg.includes("차량번호:밖에주차가 중복됩니다.")
      );
    }
    function showModal(slot) {
      modalOpen = true;
      currentSlot = slot;
      const modal = document.getElementById("modal");
      modal.style.display = "block";
      const roomInput = document.getElementById("room");
      const carInput = document.getElementById("car");
      roomInput.value = parkingRecords[slot]?.room || "";
      carInput.value = parkingRecords[slot]?.car || "";
      document.getElementById("submitBtn").onclick = () => {
        saveHistory();
        const room = roomInput.value;
        const car = carInput.value;
        parkingRecords[slot] = { room, car };
        saveParkingRecords();
        const spotElement = document.getElementById(`spot-${slot}`);
        spotElement.classList.add("occupied");
        spotElement.innerText = `${room || "-"}\n${car || "-"}`;
        updateStatus();
        modal.style.display = "none";
        modalOpen = false;
      };
      document.getElementById("removeBtn").onclick = () => {
        saveHistory();
        delete parkingRecords[slot];
        saveParkingRecords();
        const spotElement = document.getElementById(`spot-${slot}`);
        spotElement.classList.remove("occupied");
        spotElement.innerText = "";
        updateStatus();
        modal.style.display = "none";
        modalOpen = false;
      };
      document.getElementById("cancelBtn").onclick = () => {
        modal.style.display = "none";
        modalOpen = false;
      };
    }
    function toggleEditMode() {
      isEditMode = !isEditMode;
      document.getElementById("resetToDefaultBtn").style.display = isEditMode ? "inline-block" : "none";
      document.getElementById("parkingLot").classList.toggle("edit-mode", isEditMode);
    }
    function resetToDefaultSpots() {
      saveHistory();
      activeSpots = [...DEFAULT_ACTIVE_SPOTS];
      parkingRecords = {};
      saveActiveSpots();
      saveParkingRecords();
      createParkingLot();
    }
    function toggleParking(slot) {
      if (modalOpen) return;
      if (isEditMode) {
        saveHistory();
        const index = activeSpots.indexOf(slot);
        if (index === -1) {
          activeSpots.push(slot);
        } else {
          activeSpots.splice(index, 1);
          delete parkingRecords[slot];
        }
        saveActiveSpots();
        saveParkingRecords();
        createParkingLot();
      } else {
        if (activeSpots.includes(slot)) {
          showModal(slot);
        }
      }
    }
    function createParkingLot() {
      const container = document.getElementById("parkingLot");
      container.innerHTML = "";
      for (let i = 1; i <= TOTAL_SPOTS; i++) {
        const spot = document.createElement("div");
        spot.classList.add("spot");
        spot.id = `spot-${i}`;
        if (activeSpots.includes(i)) {
          spot.classList.add("active");
          if (parkingRecords[i] && parkingRecords[i].car) {
            spot.classList.add("occupied");
            spot.innerText = `${parkingRecords[i].room || "-"}\n${parkingRecords[i].car || "-"}`;
          }
        } else {
          spot.classList.add("empty");
        }
        spot.addEventListener("click", () => toggleParking(i));
        container.appendChild(spot);
      }
      updateStatus();
    }

    document.getElementById("pasteIcon").addEventListener("click", () => {
      if (modalOpen) return;
      navigator.clipboard.readText()
        .then(text => {
          if (!text) {
            alert("클립보드에 붙여넣을 텍스트가 없습니다.");
            return;
          }
          const { validData, errors, allPasteCarNumbers, allPasteRoomNumbers } = parseAndValidateData(text);
          const { previewData, errors: allErrors } = generatePreviewAndErrors(validData, parkingRecords, errors, allPasteCarNumbers, allPasteRoomNumbers);

          const uniqueErrors = filterDuplicateErrors(allErrors);
          const groupedErrors = groupErrorsByCategory(uniqueErrors);

          openPreviewModal(previewData, groupedErrors, validData);
        })
        .catch(err => {
          alert("클립보드 읽기 실패: " + err);
        });
    });

    function openPreviewModal(previewData, groupedErrors, validData) {
      const modal = document.getElementById("previewModal");
      modal.style.display = "block";

      document.getElementById("totalCount").innerText = validData.length;
      document.getElementById("matchCount").innerText = previewData.length;

      const tbody = document.getElementById("previewTableBody");
      tbody.innerHTML = "";
      previewData.forEach(item => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.slot}</td>
          <td>${item.currentCar || "-"}</td>
          <td>${item.currentRoom || "-"}</td>
          <td>${item.newRoom || "-"}</td>
          <td>${item.status}</td>
        `;
        tbody.appendChild(tr);
      });

      const previewContent = document.getElementById("previewContent");
      const errorDiv = document.createElement("div");
      errorDiv.classList.add("error-list");
      errorDiv.innerHTML = "";

      Object.entries(groupedErrors).forEach(([category, errors]) => {
        const details = document.createElement("details");
        details.open = true;
        const summary = document.createElement("summary");
        summary.innerText = `${category} (${errors.length})`;
        details.appendChild(summary);
        errors.forEach(msg => {
          const p = document.createElement("p");
          p.innerText = msg;
          details.appendChild(p);
        });
        errorDiv.appendChild(details);
      });

      previewContent.appendChild(errorDiv);

      document.getElementById("applyUpdateBtn").onclick = () => {
        saveHistory();
        previewData.forEach(({ slot, newRoom, currentCar }) => {
          if (slot && newRoom && currentCar) {
            parkingRecords[slot] = { room: newRoom, car: currentCar };
          }
        });
        saveParkingRecords();
        createParkingLot();
        modal.style.display = "none";
      };
      document.getElementById("cancelUpdateBtn").onclick = () => {
        modal.style.display = "none";
      };
    }

    document.getElementById("undoBtn").addEventListener("click", undo);
    document.getElementById("redoBtn").addEventListener("click", redo);
    document.getElementById("clearAllBtn").addEventListener("click", () => {
      if (confirm("전체 데이터를 초기화하시겠습니까?")) {
        saveHistory();
        parkingRecords = {};
        activeSpots = [];
        saveParkingRecords();
        saveActiveSpots();
        createParkingLot();
      }
    });
    document.getElementById("editModeBtn").addEventListener("click", toggleEditMode);
    document.getElementById("resetToDefaultBtn").addEventListener("click", resetToDefaultSpots);

    loadFirebaseData();

    window.addEventListener("click", e => {
      if (modalOpen && e.target.classList.contains("modal")) {
        document.getElementById("modal").style.display = "none";
        modalOpen = false;
      }
      if (document.getElementById("previewModal").style.display === "block" && e.target.classList.contains("preview-modal")) {
        document.getElementById("previewModal").style.display = "none";
      }
    });
  </script>
</body>
</html>
